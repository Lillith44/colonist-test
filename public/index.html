<!DOCTYPE html>
<html>
<head>
    <title>Ping Pong Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="800" height="400"></canvas>
<script type="text/javascript" src="js/app.js"></script>
<script type="text/javascript">
	const game_state = {
		'left_paddle_y': 0,
		'right_paddle_y': 0,
		'ball_position': [0, 0],
		'ball_speed': [-0.5, 0.1],
		'keys': {},
		'score_left': 0,
		'score_right': 0,
		'paused': false
	}

	const paddle_speed = 1;
	const ball_speed = 1;
	const paddle_height = 100;

	//Set app to correct width;
	app.width = window.innerWidth;
	app.height = window.innerHeight;

	app.onInit = function () {
		this.nodes.push(
			{
				id: 'paddle-left',
				x: 50,
				y: 0,
				width: 10,
				height: paddle_height
			}
		);

		this.nodes.push(
			{
				id: 'paddle-right',
				x: app.width - 60, //50 + 10 to compensate for width of paddle
				y: 0,
				width: 10,
				height: paddle_height
			}
		);

		this.nodes.push(
			{
				'id': 'ball',
				x: app.width / 2 - 10,
				y: app.height / 2 - 10,
				width: 20,
				height: 20
			}
		);

		game_state.ball_position = [app.width / 2, app.height / 2];
	};

	function intersects_paddle(paddle_y, ball_y) {
		return (ball_y + 10 >= paddle_y) && (ball_y - 10 <= paddle_y + paddle_height);
	}

	function reset_ball() {
		console.log(game_state.score_left + " - " + game_state.score_right);
		game_state.ball_position = [app.width / 2, app.height / 2];
		game_state.ball_position = [app.width / 2, app.height / 2];
		game_state.ball_speed[0] = -game_state.ball_speed[0];
		game_state.ball_speed[1] = (Math.random() * 3 - 1.5) / 10;
	}

	app.onUpdate = function (time) {
		if (game_state.paused) {
			return;
		}
		if (game_state.keys['ArrowDown']) {
			game_state.right_paddle_y += time * paddle_speed;
		}
		if (game_state.keys['ArrowUp']) {
			game_state.right_paddle_y -= time * paddle_speed;
		}
		if (game_state.keys['KeyS']) {
			game_state.left_paddle_y += time * paddle_speed;
		}
		if (game_state.keys['KeyW']) {
			game_state.left_paddle_y -= time * paddle_speed;
		}


		game_state.ball_position[0] += game_state.ball_speed[0] * time * ball_speed;
		game_state.ball_position[1] += game_state.ball_speed[1] * time * ball_speed;

		if (game_state.ball_position[0] > 60 && game_state.ball_position[0] < 70
			&& intersects_paddle(game_state.left_paddle_y, game_state.ball_position[1])) {
			game_state.ball_speed[0] = Math.abs(game_state.ball_speed[0]);
		} else if (game_state.ball_position[0] + 60 < app.width && game_state.ball_position[0] + 70 > app.width
			&& intersects_paddle(game_state.right_paddle_y, game_state.ball_position[1])) {
			game_state.ball_speed[0] = -Math.abs(game_state.ball_speed[0]);
		} else if (game_state.ball_position[0] < 10) {
			game_state.score_right += 1;
			reset_ball();
		} else if (game_state.ball_position[0] + 10 > app.width) {
			game_state.score_left += 1;
			reset_ball();
		}

		if (game_state.ball_position[1] < 10 || game_state.ball_position[1] > app.height - 10) {
			game_state.ball_speed[1] *= -1;
		}

		this.getNode('paddle-left').y = game_state.left_paddle_y;
		this.getNode('paddle-right').y = game_state.right_paddle_y;
		this.getNode('ball').x = game_state.ball_position[0] - 10;
		this.getNode('ball').y = game_state.ball_position[1] - 10;
	};

	app.toggle_pause = () => {
		game_state.paused ^= true;
	}

	document.addEventListener('keydown', (ev) => {
		game_state.keys[ev.code] = true;
		if (ev.code === 'Space') {
			app.toggle_pause();
		}

	});
	document.addEventListener('keyup', (ev) => {
		game_state.keys[ev.code] = false;

	})
</script>
</body>
</html>